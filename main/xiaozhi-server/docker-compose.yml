# Docker安装Server

version: '3'
services:
  xiaozhi-esp32-server:
    image: ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:server_latest
    container_name: xiaozhi-esp32-server
    restart: always
    security_opt:
      - seccomp:unconfined
    environment:
      - TZ=Europe/Rome
    network_mode: host
    # Healthcheck: verifica che il server HTTP risponda (usa Python perché curl non è nel container)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/xiaozhi/ota/', timeout=5)"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      # 配置文件目录
      - ./data:/opt/xiaozhi-esp32-server/data
      # 模型文件挂接，很重要
      - ./models/SenseVoiceSmall/model.pt:/opt/xiaozhi-esp32-server/models/SenseVoiceSmall/model.pt
      # Plugin personalizzati
      - ./plugins_func/functions:/opt/xiaozhi-esp32-server/plugins_func/functions
      # Core modificato (connection registry, reminder scheduler)
      - ./core:/opt/xiaozhi-esp32-server/core
      # App.py modificato
      - ./app.py:/opt/xiaozhi-esp32-server/app.py